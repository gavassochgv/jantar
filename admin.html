<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Cardápio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-gray-100 text-stone-800">

    <!-- Seção de Login -->
    <div id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center mb-6 text-stone-800" style="font-family: 'Playfair Display', serif;">Login de Administrador</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-stone-700 mb-1">Usuário</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-stone-700 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                </div>
                <button type="submit" class="w-full bg-orange-600 text-white py-2 rounded-md hover:bg-orange-700 transition-colors">Entrar</button>
            </form>
            <p id="login-error" class="text-red-500 text-center mt-4 hidden">Login ou senha inválidos.</p>
        </div>
    </div>
    
    <!-- Conteúdo principal do Admin (oculto por padrão) -->
    <div id="admin-main-content" class="hidden">
        <!-- Navegação -->
        <nav class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl text-orange-600">Jantares Exclusivos - Admin</h1>
            <div>
                <a href="index.html" class="text-stone-600 hover:text-orange-600 mr-4">Página Inicial</a>
                <a href="vitrine.html" class="text-stone-600 hover:text-orange-600">Vitrine</a>
            </div>
        </nav>
        
        <div class="container mx-auto p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Coluna 1: Gerenciar Usuários e Destaque da Vitrine -->
            <div class="lg-col-span-1 bg-white p-6 rounded-xl shadow-lg flex flex-col gap-8">
                <div>
                    <h2 class="text-3xl mb-6 border-b pb-3">Gerenciar Usuários</h2>
                    <form id="add-user-form" class="flex gap-2 mb-4">
                        <input type="text" id="user-name" placeholder="Nome do novo usuário" class="flex-grow p-2 border rounded-md" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Adicionar</button>
                    </form>
                    <div id="admin-user-list" class="space-y-2">
                        <!-- Lista de usuários para admin -->
                        <p>Carregando...</p>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-3xl mb-6 border-b pb-3">Destaque da Vitrine</h2>
                    <div id="vitrine-destaque-admin">
                        <p class="text-stone-500">Carregando destaque...</p>
                    </div>
                </div>
            </div>

            <!-- Coluna 2: Gerenciar Jantares -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 border-b pb-3">
                    <h2 class="text-3xl">Gerenciar Jantares</h2>
                    <button id="open-jantar-modal-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Criar Novo Jantar</button>
                </div>
                <div id="jantar-list" class="space-y-4">
                    <!-- Lista de jantares -->
                    <p>Carregando jantares...</p>
                </div>
            </div>
        </div>

        <!-- Modal para Criar/Editar Jantar -->
        <div id="jantar-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-40">
            <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h3 id="jantar-modal-title" class="text-3xl mb-6">Criar Novo Jantar</h3>
                <form id="jantar-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="jantar-date" class="block font-medium">Data do Jantar</label>
                            <input type="date" id="jantar-date" class="w-full p-2 border rounded-md" required>
                        </div>
                        <div>
                            <label for="vitrine-image" class="block font-medium">URL da Foto para Vitrine do Jantar</label>
                            <input type="url" id="vitrine-image" placeholder="https://exemplo.com/foto.jpg" class="w-full p-2 border rounded-md">
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="text-xl font-bold mb-2">Cardápio</h4>
                        <!-- ENTRADA -->
                        <div class="bg-gray-50 p-4 rounded-md mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-semibold text-lg">Entrada</h5>
                                <button type="button" class="add-menu-item-btn bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600" data-type="entrada">Adicionar Opção</button>
                            </div>
                            <div id="entrada-items" class="space-y-3">
                                <!-- Opções de entrada dinâmicas aqui -->
                            </div>
                        </div>
                        <!-- PRATO PRINCIPAL -->
                        <div class="bg-gray-50 p-4 rounded-md mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-semibold text-lg">Prato Principal</h5>
                                <button type="button" class="add-menu-item-btn bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600" data-type="principal">Adicionar Opção</button>
                            </div>
                            <div id="principal-items" class="space-y-3">
                                <!-- Opções de prato principal dinâmicas aqui -->
                            </div>
                        </div>
                        <!-- SOBREMESA -->
                        <div class="bg-gray-50 p-4 rounded-md">
                             <div class="flex justify-between items-center mb-2">
                                <h5 class="font-semibold text-lg">Sobremesa</h5>
                                <button type="button" class="add-menu-item-btn bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600" data-type="sobremesa">Adicionar Opção</button>
                            </div>
                            <div id="sobremesa-items" class="space-y-3">
                                <!-- Opções de sobremesa dinâmicas aqui -->
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="text-xl font-bold mb-2">Convidar Usuários</h4>
                        <div id="invite-user-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-48 overflow-y-auto border p-2 rounded-md"></div>
                    </div>
                    <div class="flex justify-end gap-4 mt-8">
                        <button type="button" id="close-jantar-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Cancelar</button>
                        <button type="submit" class="bg-orange-600 text-white px-6 py-2 rounded-md hover:bg-orange-700">Salvar Jantar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para Gerenciar Vitrine -->
        <div id="vitrine-manage-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h3 id="vitrine-modal-title" class="text-3xl mb-6">Gerenciar Vitrine do Jantar</h3>
                <!-- Formulário para foto -->
                <form id="vitrine-photo-form" class="space-y-4 mb-6 border-b pb-6">
                    <div>
                        <label for="vitrine-manage-image" class="block font-medium">URL da Foto para Vitrine</label>
                        <div class="flex gap-2">
                            <input type="url" id="vitrine-manage-image" placeholder="https://exemplo.com/foto.jpg" class="w-full p-2 border rounded-md">
                            <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700">Salvar Foto</button>
                        </div>
                    </div>
                </form>
                <!-- Lista de Avaliações -->
                <div>
                    <h4 class="text-xl font-bold mb-4">Avaliações e Comentários</h4>
                    <div id="avaliacoes-list" class="space-y-4">
                        <!-- Avaliações serão carregadas aqui -->
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="close-vitrine-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Fechar</button>
                </div>
            </div>
        </div>

        <!-- NOVO: Modal para Ver Escolhas -->
        <div id="choices-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 id="choices-modal-title" class="text-3xl mb-6">Escolhas dos Clientes</h3>
                <div id="choices-list" class="space-y-4">
                    <!-- Escolhas serão carregadas aqui -->
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="close-choices-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD89Q_VbBBshMKOV53oT_4Nyhd2d_ZJ2bw",
            authDomain: "cardapio-abc1e.firebaseapp.com",
            projectId: "cardapio-abc1e",
            storageBucket: "cardapio-abc1e.appspot.com",
            messagingSenderId: "1052047749183",
            appId: "1:1052047749183:web:1baac736b27f0effed088a",
            measurementId: "G-VZN8FLXRCN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Lógica de Login ---
        const loginSection = document.getElementById('login-section');
        const adminMainContent = document.getElementById('admin-main-content');
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'carloshh' && password === '100406') {
                loginSection.classList.add('hidden');
                adminMainContent.classList.remove('hidden');
                initializeAdminPanel(); 
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        // --- Lógica do Painel do Admin ---
        const addUserForm = document.getElementById('add-user-form');
        const adminUserListDiv = document.getElementById('admin-user-list');
        const jantarListDiv = document.getElementById('jantar-list');
        let currentEditingJantarId = null;
        
        // Lógica dos Modais
        const jantarModal = document.getElementById('jantar-modal');
        const jantarForm = document.getElementById('jantar-form');

        const openCreateJantarModal = () => {
            currentEditingJantarId = null;
            jantarForm.reset();
            // Limpa itens de menu existentes e adiciona um item inicial para cada categoria
            ['entrada', 'principal', 'sobremesa'].forEach(type => {
                const container = document.getElementById(`${type}-items`);
                container.innerHTML = '';
                addMenuItem(type);
            });
            document.getElementById('jantar-modal-title').textContent = 'Criar Novo Jantar';
            jantarModal.classList.remove('hidden');
        };

        const closeJantarModal = () => {
            jantarModal.classList.add('hidden');
            currentEditingJantarId = null;
        };
        
        document.getElementById('open-jantar-modal-btn').addEventListener('click', openCreateJantarModal);
        document.getElementById('close-jantar-modal-btn').addEventListener('click', closeJantarModal);


        // Lógica do modal de gerenciar vitrine
        const vitrineManageModal = document.getElementById('vitrine-manage-modal');
        const vitrinePhotoForm = document.getElementById('vitrine-photo-form');
        const avaliacoesListDiv = document.getElementById('avaliacoes-list');
        let currentJantarId = null;
        let unsubscribeAvaliacoes = null;

        document.getElementById('close-vitrine-modal-btn').onclick = () => {
            vitrineManageModal.classList.add('hidden');
            if (unsubscribeAvaliacoes) {
                unsubscribeAvaliacoes(); // Limpa o listener ao fechar
            }
        };

        // Lógica do modal de ver escolhas
        const choicesModal = document.getElementById('choices-modal');
        document.getElementById('close-choices-modal-btn').onclick = () => {
            choicesModal.classList.add('hidden');
        };


        // Adicionar usuário
        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userNameInput = document.getElementById('user-name');
            const name = userNameInput.value.trim();
            if (name) {
                await addDoc(collection(db, 'users'), { name });
                userNameInput.value = '';
            }
        });

        function setupListeners() {
            // Exibir e gerenciar usuários
            onSnapshot(collection(db, 'users'), (snapshot) => {
                let usersHtml = '', inviteUsersHtml = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    usersHtml += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded-md"><span>${user.name}</span><button data-id="${doc.id}" class="delete-user-btn text-red-500 hover:text-red-700">Excluir</button></div>`;
                    inviteUsersHtml += `<label class="flex items-center space-x-2 p-1 rounded hover:bg-amber-100 cursor-pointer"><input type="checkbox" name="convidado" value="${doc.id}" class="form-checkbox rounded text-orange-600"><span>${user.name}</span></label>`;
                });
                adminUserListDiv.innerHTML = usersHtml || 'Nenhum usuário cadastrado.';
                document.getElementById('invite-user-list').innerHTML = inviteUsersHtml;
            });
            
            // Listar jantares e atualizar destaque
            onSnapshot(collection(db, 'jantares'), (snapshot) => {
                const jantaresFinalizadosComFoto = snapshot.docs.map(doc => doc.data()).filter(j => j.status === 'finalizado' && j.vitrineImage).sort((a, b) => new Date(b.date) - new Date(a.date));
                const destaqueDiv = document.getElementById('vitrine-destaque-admin');
                if (destaqueDiv) {
                    if (jantaresFinalizadosComFoto.length > 0) {
                        const jantarDestaque = jantaresFinalizadosComFoto[0];
                        destaqueDiv.innerHTML = `<p class="font-medium mb-2">Jantar de ${new Date(jantarDestaque.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p><img src="${jantarDestaque.vitrineImage}" alt="Foto destaque" class="w-full h-auto rounded-md shadow-sm object-cover"/>`;
                    } else {
                        destaqueDiv.innerHTML = '<p class="text-stone-500">Nenhum jantar com foto para destacar.</p>';
                    }
                }

                let jantaresHtml = '';
                const sortedDocs = snapshot.docs.sort((a, b) => (a.data().createdAt?.seconds || 0) < (b.data().createdAt?.seconds || 0) ? 1 : -1);
                sortedDocs.forEach(doc => {
                    const jantar = doc.data();
                    let statusClass = '', actions = '';
                    switch(jantar.status) {
                        case 'agendado':
                            statusClass = 'bg-blue-200 text-blue-800';
                            actions = `<button data-id="${doc.id}" class="start-jantar-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Iniciar Sessão</button>`;
                            break;
                        case 'em-sessao':
                            statusClass = 'bg-yellow-200 text-yellow-800';
                            actions = `<button data-id="${doc.id}" class="finish-jantar-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Finalizar</button>`;
                            break;
                        case 'finalizado':
                            statusClass = 'bg-gray-200 text-gray-800';
                            actions = `<button data-id="${doc.id}" class="manage-vitrine-btn bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">Gerenciar Vitrine</button>`;
                            break;
                    }
                    jantaresHtml += `<div class="bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><div><p class="font-bold text-lg">${new Date(jantar.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p><p>Convidados: ${jantar.convidados ? jantar.convidados.length : 0}</p></div><div class="flex items-center gap-4"><span class="text-sm font-medium px-2 py-1 rounded-full ${statusClass}">${jantar.status}</span><div class="flex items-center flex-wrap gap-2">${actions}<button data-id="${doc.id}" class="view-choices-btn bg-sky-500 text-white px-3 py-1 rounded hover:bg-sky-600">Ver Escolhas</button><button data-id="${doc.id}" class="edit-jantar-btn bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Editar</button><button data-id="${doc.id}" class="whatsapp-jantar-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">WhatsApp</button><button data-id="${doc.id}" class="delete-jantar-btn bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Excluir</button></div></div></div>`;
                });
                jantarListDiv.innerHTML = jantaresHtml || '<p>Nenhum jantar criado ainda.</p>';
            });
        }
        
        // Deletar usuário
        adminUserListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-user-btn')) {
                await deleteDoc(doc(db, 'users', e.target.dataset.id));
            }
        });
        
        // Salvar ou Atualizar Jantar
        jantarForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const getMenuItems = (type) => {
                const items = [];
                document.querySelectorAll(`#${type}-items .menu-item`).forEach(itemDiv => {
                    const nome = itemDiv.querySelector('input[data-field="nome"]').value;
                    const descricao = itemDiv.querySelector('textarea[data-field="descricao"]').value;
                    const foto = itemDiv.querySelector('input[data-field="foto"]').value;
                    if (nome) { // Only add if name is present
                        items.push({ nome, descricao, foto });
                    }
                });
                return items;
            };
            const invitedUsers = Array.from(document.querySelectorAll('#invite-user-list input:checked')).map(cb => cb.value);
            const jantarData = {
                date: document.getElementById('jantar-date').value,
                vitrineImage: document.getElementById('vitrine-image').value,
                menu: { 
                    entrada: getMenuItems('entrada'), 
                    principal: getMenuItems('principal'), 
                    sobremesa: getMenuItems('sobremesa') 
                },
                convidados: invitedUsers,
            };

            if (currentEditingJantarId) {
                await updateDoc(doc(db, 'jantares', currentEditingJantarId), jantarData);
            } else {
                jantarData.status = 'agendado';
                jantarData.createdAt = serverTimestamp();
                await addDoc(collection(db, 'jantares'), jantarData);
            }
            closeJantarModal();
        });

        const openJantarModalForEdit = async (jantarId) => {
            jantarForm.reset();
            const jantarRef = doc(db, 'jantares', jantarId);
            const jantarSnap = await getDoc(jantarRef);
            if (!jantarSnap.exists()) return;
            
            const jantarData = jantarSnap.data();
            currentEditingJantarId = jantarId;

            document.getElementById('jantar-modal-title').textContent = 'Editar Jantar';
            document.getElementById('jantar-date').value = jantarData.date;
            document.getElementById('vitrine-image').value = jantarData.vitrineImage || '';

            // Limpa e popula os itens de menu
            ['entrada', 'principal', 'sobremesa'].forEach(type => {
                const container = document.getElementById(`${type}-items`);
                container.innerHTML = '';
                const items = jantarData.menu[type] || [];
                if (items.length > 0) {
                    items.forEach(itemData => addMenuItem(type, itemData));
                } else {
                     addMenuItem(type); // Add at least one empty item if none exist
                }
            });

            document.querySelectorAll('#invite-user-list input[name="convidado"]').forEach(checkbox => {
                checkbox.checked = (jantarData.convidados || []).includes(checkbox.value);
            });
            jantarModal.classList.remove('hidden');
        };

        // Gerenciar status, edição e exclusão de jantares
        jantarListDiv.addEventListener('click', async (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('whatsapp-jantar-btn')) {
                const jantarRef = doc(db, 'jantares', id);
                const jantarSnap = await getDoc(jantarRef);
                if (jantarSnap.exists()) {
                    const jantarData = jantarSnap.data();
                    const date = new Date(jantarData.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    const message = `Olá! Você foi convidado para um Jantar Exclusivo no dia ${date}. Acesse o site para confirmar sua presença e escolher seu menu: https://jantar-lake.vercel.app/index.html`;
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                }
                return;
            }

            if (target.classList.contains('edit-jantar-btn')) {
                openJantarModalForEdit(id);
                return;
            }

            if (target.classList.contains('view-choices-btn')) {
                openChoicesModal(id);
                return;
            }

            let newStatus = '';
            if (target.classList.contains('start-jantar-btn')) newStatus = 'em-sessao';
            if (target.classList.contains('finish-jantar-btn')) newStatus = 'finalizado';
            if (newStatus) {
                await updateDoc(doc(db, 'jantares', id), { status: newStatus });
            }
            if (target.classList.contains('manage-vitrine-btn')) {
                openVitrineManagementModal(id);
            }
            if (target.classList.contains('delete-jantar-btn')) {
                if (confirm('Tem certeza que deseja excluir este jantar? Todas as avaliações e escolhas relacionadas também serão excluídas.')) {
                    const subcollections = ['avaliacoes', 'escolhas'];
                    for (const sub of subcollections) {
                        const subRef = collection(db, 'jantares', id, sub);
                        const snapshot = await getDocs(subRef);
                        const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                        await Promise.all(deletePromises);
                    }
                    await deleteDoc(doc(db, 'jantares', id));
                }
            }
        });
        
        async function openChoicesModal(jantarId) {
            const jantarDoc = await getDoc(doc(db, 'jantares', jantarId));
            if (!jantarDoc.exists()) return;
            const jantarData = jantarDoc.data();
            const choicesListDiv = document.getElementById('choices-list');

            document.getElementById('choices-modal-title').textContent = `Escolhas para o Jantar de ${new Date(jantarData.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`;
            
            choicesListDiv.innerHTML = '<p>Carregando escolhas...</p>';
            choicesModal.classList.remove('hidden');

            const choicesRef = collection(db, 'jantares', jantarId, 'escolhas');
            const choicesSnapshot = await getDocs(choicesRef);

            let html = '';
            if (choicesSnapshot.empty) {
                html = '<p class="text-stone-500">Nenhum cliente fez suas escolhas ainda.</p>';
            } else {
                choicesSnapshot.forEach(doc => {
                    const escolha = doc.data();
                    const entrada = (escolha.entrada && escolha.entrada.itemName) ? escolha.entrada.itemName : 'Não escolhida';
                    const principal = (escolha.principal && escolha.principal.itemName) ? escolha.principal.itemName : 'Não escolhido';
                    const sobremesa = (escolha.sobremesa && escolha.sobremesa.itemName) ? escolha.sobremesa.itemName : 'Não escolhida';
                    
                    html += `
                        <div class="bg-gray-50 p-3 rounded-md border">
                            <p class="font-bold">${escolha.userName}</p>
                            <ul class="list-disc list-inside text-sm text-gray-700 mt-1">
                                <li><strong>Entrada:</strong> ${entrada}</li>
                                <li><strong>Principal:</strong> ${principal}</li>
                                <li><strong>Sobremesa:</strong> ${sobremesa}</li>
                            </ul>
                        </div>
                    `;
                });
            }
            choicesListDiv.innerHTML = html;
        }

        async function openVitrineManagementModal(jantarId) {
            currentJantarId = jantarId;
            const jantarDoc = await getDoc(doc(db, 'jantares', jantarId));
            const jantarData = jantarDoc.data();

            document.getElementById('vitrine-modal-title').textContent = `Gerenciar Vitrine do Jantar de ${new Date(jantarData.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`;
            document.getElementById('vitrine-manage-image').value = jantarData.vitrineImage || '';
            
            vitrineManageModal.classList.remove('hidden');

            const avaliacoesRef = collection(db, 'jantares', jantarId, 'avaliacoes');
            unsubscribeAvaliacoes = onSnapshot(avaliacoesRef, (snapshot) => {
                let html = '';
                if(snapshot.empty) {
                    html = '<p class="text-stone-500">Nenhuma avaliação para este jantar.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const avaliacao = doc.data();
                        const entrada = avaliacao.entrada || {};
                        const principal = avaliacao.principal || {};
                        const sobremesa = avaliacao.sobremesa || {};
                        html += `
                            <div class="bg-gray-50 p-3 rounded-md border">
                                <div class="flex justify-between items-start">
                                    <p class="font-bold">${avaliacao.userName}</p>
                                    <button data-avaliacao-id="${doc.id}" class="delete-avaliacao-btn text-red-500 hover:text-red-700 text-sm">Remover</button>
                                </div>
                                <div class="mt-2 text-sm space-y-1 border-t pt-2">
                                     <p class="font-semibold">Escolhas do Menu:</p>
                                     <ul class="list-disc list-inside text-gray-700">
                                        <li><strong>Entrada:</strong> ${entrada.itemName || 'Não escolhida'}</li>
                                        <li><strong>Principal:</strong> ${principal.itemName || 'Não escolhido'}</li>
                                        <li><strong>Sobremesa:</strong> ${sobremesa.itemName || 'Não escolhida'}</li>
                                     </ul>
                                     <p class="font-semibold pt-2">Avaliações:</p>
                                     <div class="pl-2 text-gray-700">
                                        <p><strong>Entrada:</strong> (${entrada.rating || 'N/A'}/10) - <em>${entrada.comment || 'Sem comentário'}</em></p>
                                        <p><strong>Principal:</strong> (${principal.rating || 'N/A'}/10) - <em>${principal.comment || 'Sem comentário'}</em></p>
                                        <p><strong>Sobremesa:</strong> (${sobremesa.rating || 'N/A'}/10) - <em>${sobremesa.comment || 'Sem comentário'}</em></p>
                                     </div>
                                </div>
                            </div>
                        `;
                    });
                }
                avaliacoesListDiv.innerHTML = html;
            });
        }

        vitrinePhotoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentJantarId) return;
            const newUrl = document.getElementById('vitrine-manage-image').value;
            await updateDoc(doc(db, 'jantares', currentJantarId), { vitrineImage: newUrl });
            alert('Foto da vitrine atualizada!');
        });
        
        avaliacoesListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-avaliacao-btn')) {
                const avaliacaoId = e.target.dataset.avaliacaoId;
                if(confirm('Tem certeza que deseja remover esta avaliação?')) {
                    await deleteDoc(doc(db, 'jantares', currentJantarId, 'avaliacoes', avaliacaoId));
                }
            }
        });

        // --- Lógica do Menu Dinâmico ---
        function addMenuItem(type, data = {}) {
            const container = document.getElementById(`${type}-items`);
            if (container.children.length >= 3) {
                alert(`Você pode adicionar no máximo 3 opções de ${type}.`);
                return;
            }
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item border-t pt-3';
            itemDiv.innerHTML = `
                <div class="flex justify-end">
                    <button type="button" class="remove-menu-item-btn text-red-500 hover:text-red-700 text-xs">Remover</button>
                </div>
                <input type="text" placeholder="Nome da Opção" data-field="nome" class="w-full p-2 border rounded-md mb-2" value="${data.nome || ''}" required>
                <textarea placeholder="Descrição da Opção" data-field="descricao" rows="2" class="w-full p-2 border rounded-md mb-2">${data.descricao || ''}</textarea>
                <input type="url" placeholder="URL da Foto da Opção" data-field="foto" class="w-full p-2 border rounded-md" value="${data.foto || ''}">
            `;
            container.appendChild(itemDiv);
        }

        jantarModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-menu-item-btn')) {
                addMenuItem(e.target.dataset.type);
            }
            if (e.target.classList.contains('remove-menu-item-btn')) {
                const itemDiv = e.target.closest('.menu-item');
                const container = itemDiv.parentElement;
                // Não permite remover o último item
                if (container.children.length > 1) {
                    itemDiv.remove();
                } else {
                    alert('Deve haver pelo menos uma opção.');
                }
            }
        });


        async function initializeAdminPanel() {
            try {
                await signInAnonymously(auth);
                setupListeners();
            } catch (error) {
                console.error("Erro na autenticação anônima: ", error);
            }
        }
    </script>
</body>
</html>

