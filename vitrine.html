<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitrine de Jantares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-gray-100 text-stone-800">

    <!-- Navegação -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl text-orange-600">Vitrine de Jantares</h1>
        <div>
            <a href="index.html" class="text-stone-600 hover:text-orange-600 mr-4">Página Inicial</a>
            <a href="admin.html" class="text-stone-600 hover:text-orange-600">Admin</a>
        </div>
    </nav>
    
    <div class="container mx-auto p-8">

        <!-- Foto do Dia do Jantar -->
        <div id="foto-do-dia-container" class="mb-12">
            <h2 class="text-4xl text-center mb-6">Destaque do Jantar Mais Recente</h2>
            <div id="foto-do-dia-content" class="bg-white p-4 rounded-xl shadow-lg max-w-4xl mx-auto">
                <p class="text-center">Carregando foto...</p>
            </div>
        </div>

        <h2 class="text-4xl text-center mb-8">Avaliações dos Jantares</h2>
        
        <div id="vitrine-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Cards de jantares finalizados -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD89Q_VbBBshMKOV53oT_4Nyhd2d_ZJ2bw",
            authDomain: "cardapio-abc1e.firebaseapp.com",
            projectId: "cardapio-abc1e",
            storageBucket: "cardapio-abc1e.appspot.com",
            messagingSenderId: "1052047749183",
            appId: "1:1052047749183:web:1baac736b27f0effed088a",
            measurementId: "G-VZN8FLXRCN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const vitrineGrid = document.getElementById('vitrine-grid');
        const fotoDoDiaContent = document.getElementById('foto-do-dia-content');

        // Função para renderizar as estrelas
        function renderStars(rating, size = 'w-4 h-4') {
            const totalStars = 10;
            let starsHtml = '<div class="flex items-center gap-px">';
            const starIconSVG = `<svg class="${size}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;

            for (let i = 1; i <= totalStars; i++) {
                const starClass = i <= Math.round(rating) ? 'text-amber-500' : 'text-gray-300';
                starsHtml += `<span class="${starClass}">${starIconSVG}</span>`;
            }
            starsHtml += '</div>';
            return starsHtml;
        }

        async function main() {
            try {
                await signInAnonymously(auth);

                // Carregar Jantares e Foto Destaque
                const q = query(collection(db, "jantares"), where("status", "==", "finalizado"));
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        vitrineGrid.innerHTML = '<p class="col-span-full text-center">Nenhum jantar finalizado para exibir.</p>';
                        fotoDoDiaContent.innerHTML = '<p class="text-center text-stone-500">Nenhuma foto de jantares para exibir.</p>';
                        return;
                    }

                    const jantaresFinalizados = snapshot.docs
                        .map(doc => doc.data())
                        .sort((a, b) => new Date(b.date) - new Date(a.date));

                    // Lógica para a foto destaque
                    const jantarComFoto = jantaresFinalizados.find(j => j.vitrineImage);
                    if (jantarComFoto) {
                        fotoDoDiaContent.innerHTML = `
                            <figure>
                                <img src="${jantarComFoto.vitrineImage}" alt="Foto do Jantar" class="w-full h-auto object-cover rounded-lg max-h-96">
                                <figcaption class="text-center text-stone-600 mt-2 text-sm">
                                    Jantar de ${new Date(jantarComFoto.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}
                                </figcaption>
                            </figure>
                        `;
                    } else {
                        fotoDoDiaContent.innerHTML = '<p class="text-center text-stone-500">Nenhuma foto de jantares para exibir.</p>';
                    }

                    const jantaresPromises = snapshot.docs.map(async (jantarDoc) => {
                        const jantar = jantarDoc.data();
                        const avaliacoesCollection = collection(db, 'jantares', jantarDoc.id, 'avaliacoes');
                        const avaliacoesSnapshot = await getDocs(avaliacoesCollection);
                        
                        let avaliacoesHtml = '';
                        let mediaEntrada = 0, mediaPrincipal = 0, mediaSobremesa = 0;
                        let mediaHtml = '';

                        if (!avaliacoesSnapshot.empty) {
                            const count = avaliacoesSnapshot.size;
                            let totalEntrada = 0, totalPrincipal = 0, totalSobremesa = 0;

                            avaliacoesSnapshot.forEach(avaDoc => {
                                const avaliacao = avaDoc.data();
                                const entrada = avaliacao.entrada || {};
                                const principal = avaliacao.principal || {};
                                const sobremesa = avaliacao.sobremesa || {};

                                totalEntrada += Number(entrada.rating) || 0;
                                totalPrincipal += Number(principal.rating) || 0;
                                totalSobremesa += Number(sobremesa.rating) || 0;

                                avaliacoesHtml += `
                                    <div class="border-t mt-4 pt-4">
                                        <p class="font-semibold">${avaliacao.userName}</p>
                                        <div class="text-sm text-stone-600 space-y-2 mt-2">
                                            <div>
                                                <strong class="block">Entrada:</strong>
                                                <div class="flex items-center gap-2">${renderStars(entrada.rating)} <span class="text-xs">(${entrada.rating}/10)</span></div>
                                                <p class="pl-1 italic">"${entrada.comment || 'Sem comentário'}"</p>
                                            </div>
                                            <div>
                                                <strong class="block">Principal:</strong>
                                                <div class="flex items-center gap-2">${renderStars(principal.rating)} <span class="text-xs">(${principal.rating}/10)</span></div>
                                                <p class="pl-1 italic">"${principal.comment || 'Sem comentário'}"</p>
                                            </div>
                                            <div>
                                                <strong class="block">Sobremesa:</strong>
                                                <div class="flex items-center gap-2">${renderStars(sobremesa.rating)} <span class="text-xs">(${sobremesa.rating}/10)</span></div>
                                                <p class="pl-1 italic">"${sobremesa.comment || 'Sem comentário'}"</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            mediaEntrada = (totalEntrada / count).toFixed(1);
                            mediaPrincipal = (totalPrincipal / count).toFixed(1);
                            mediaSobremesa = (totalSobremesa / count).toFixed(1);

                             mediaHtml = `
                                <div class="font-bold mb-4 space-y-2 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span>Média Entrada:</span>
                                        <div class="flex items-center gap-2">${renderStars(mediaEntrada)} <span class="text-xs font-normal text-stone-600">(${mediaEntrada}/10)</span></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Média Principal:</span>
                                        <div class="flex items-center gap-2">${renderStars(mediaPrincipal)} <span class="text-xs font-normal text-stone-600">(${mediaPrincipal}/10)</span></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Média Sobremesa:</span>
                                        <div class="flex items-center gap-2">${renderStars(mediaSobremesa)} <span class="text-xs font-normal text-stone-600">(${mediaSobremesa}/10)</span></div>
                                    </div>
                                </div>
                            `;

                        } else {
                            avaliacoesHtml = '<p class="text-sm text-stone-500 mt-4">Ainda não há avaliações.</p>';
                            mediaHtml = '<p class="text-sm text-stone-500 mb-4">Aguardando avaliações para calcular a média.</p>';
                        }
                        
                        return {
                            date: new Date(jantar.date),
                            html: `
                                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col">
                                    ${jantar.vitrineImage ? `<img src="${jantar.vitrineImage}" alt="Jantar de ${new Date(jantar.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}" class="w-full h-48 object-cover rounded-md mb-4">` : ''}
                                    <h3 class="text-2xl mb-2">${new Date(jantar.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</h3>
                                    ${mediaHtml}
                                    <div class="flex-grow">${avaliacoesHtml}</div>
                                </div>`
                        };
                    });
                    
                    Promise.all(jantaresPromises).then(jantares => {
                        jantares.sort((a, b) => b.date - a.date);
                        vitrineGrid.innerHTML = jantares.map(j => j.html).join('');
                    });
                }, (error) => {
                    console.error("Erro ao carregar jantares para vitrine: ", error);
                    vitrineGrid.innerHTML = '<p class="col-span-full text-center text-red-500">Ocorreu um erro ao carregar os jantares.</p>';
                });

            } catch (error) {
                console.error("Erro na autenticação: ", error);
                vitrineGrid.innerHTML = '<p class="col-span-full text-center text-red-500">Falha na conexão com o banco de dados.</p>';
            }
        }
        main();
    </script>
</body>
</html>

